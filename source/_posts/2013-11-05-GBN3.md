---
layout: post
title: "Genetic Bayesian Network (III)"
date: 2013-11-05 08:01
comments: true
categories: PGN, genetic
---

[UPDATE] I have updated a posteriori the code to include the vectorized version of Factor manipulations, which is incredibly faster and will be explained in a later post.

A better model that increases flexibility and simplicity is the one that decouples the genes in the following manner:

{% img center /images/nov13/decoupled_template.png 600 Template for Genetic Bayesian Network%}

```python factors
def genes2Alleles(numAlleles):
    sol = {}
    count = 0
    for i in range(numAlleles):
        for j in range(i, numAlleles):
            sol[(i,j)] = count
            count +=1
    return sol

def alleles2Genes(numAlleles):
    sol = {}
    count = 0
    for i in range(numAlleles):
        for j in range(numAlleles):
            if i < j:
                sol[count] = (i,j)
            else:
                sol[count] = (j, i)
            count +=1
    return sol

def Factor_genotype_given_allele_freqs(alleleFreqs, genoVar):
    f = Factor.Factor([genoVar])
    f.fill_values(alleleFreqs)
    return f

def Factor_genotype_given_parents_genes(numAlleles, genKid, gen_parent_1, gen_parent_2):
    ff = Factor.Factor([genKid, gen_parent_1, gen_parent_2])
    arr = ff.values.flatten()
    alleleProbsCount = 0;
    for i in range(numAlleles):
        for j in range(numAlleles):
            for k in range(numAlleles):
                if j == k:
                    if i == k:
                        arr[alleleProbsCount] = 1.
                    else:
                        arr[alleleProbsCount] = .5
                elif i == k:
                    arr[alleleProbsCount] = .5
                alleleProbsCount += 1
    ff.fill_values(arr)
    return ff

def Factor_phenotype_given_genotype_Not_Mendelian(alphaList, numAlleles, genoVar_1, genoVar_2, phenoVar):
    ff = Factor.Factor([phenoVar, genoVar_1, genoVar_2]) # written like in cond prob order    
    
    chocho = alleles2Genes(numAlleles)
    chochin = genes2Alleles(numAlleles)
    cols_CPD = genoVar_1.totCard() * genoVar_2.totCard()
    arr = ff.values.flatten()

    for i in range(len(chocho)):
        k = chocho[i] 
        v = alphaList[chochin[k]]
        arr[2*i] = v        # trait present
        arr[2*i+1] = 1-v    # trait absent
    ff.fill_values(arr)
    return ff

def geneticNetwork(pedigree, alleleFreqs, alphaList):
    PHENOTYPE_CARD = 2 # present or absent
    numAlleles = len(alleleFreqs)

    varList = {}

    # first we create all variables
    count = 0
    for name in pedigree:
        varList[name] = {}
        dad_gn, mom_gn = pedigree[name]
        varList[name]['var_geno1'] = Rvar.Rvar(count, numAlleles)
        count +=1
        varList[name]['var_geno2'] = Rvar.Rvar(count, numAlleles)
        count +=1
        varList[name]['var_pheno'] = Rvar.Rvar(count, PHENOTYPE_CARD)
        count +=1

    # and now the factors
    for name in pedigree:
        kid_gn1 = varList[name]['var_geno1']
        kid_gn2 = varList[name]['var_geno2']
        kid_ph  = varList[name]['var_pheno']

        dad_gn, mom_gn = pedigree[name]
        if dad_gn and mom_gn:
            f1 = Factor_genotype_given_parents_genes(numAlleles, kid_gn1, varList[dad_gn]['var_geno1'], varList[dad_gn]['var_geno2'])
            f2 = Factor_genotype_given_parents_genes(numAlleles, kid_gn2, varList[mom_gn]['var_geno1'], varList[mom_gn]['var_geno2'])
        else:
            f1 = Factor_genotype_given_allele_freqs(alleleFreqs, kid_gn1)
            f2 = Factor_genotype_given_allele_freqs(alleleFreqs, kid_gn2)
        varList[name]['factor_geno1'] = f1
        varList[name]['factor_geno2'] = f2

        varList[name]['factor_pheno'] = Factor_phenotype_given_genotype_Not_Mendelian(alphaList, numAlleles, kid_gn1, kid_gn2, kid_ph)

    return varList

# this is fugly
def modify_Factor_by_evidence(name, node, ass):
    factor = GN[name]['factor_'+node]
    randvar = GN[name]['var_'+node]
    GN[name]['factor_'+node] = FactorOperations.observe(factor, {randvar:ass})

def build_joint_cpd():
    a = None
    for k in GN.keys():
        b = FactorOperations.multiply(GN[k]['factor_geno1'], GN[k]['factor_geno2'])
        b = FactorOperations.multiply(b, GN[k]['factor_pheno'])
        if a==None:
            a = b
        else:
            a = FactorOperations.multiply(a, b)
    return a
```

