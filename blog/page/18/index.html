
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>SotoSeattle</title>
  <meta name="author" content="Javier Soto">

  
  <meta name="description" content="[UPDATE] I have updated a posteriori the code to include the vectorized version of Factor manipulations, which is incredibly faster and will be &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://sotoseattle.github.io/blog/page/18">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="" rel="alternate" title="SotoSeattle" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
<!-- MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["$$","$$"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript"
   src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner">
	<div class="header-title"><a href="/">SotoSeattle</a></div>


	<br><div class="header-subtitle">Curious Coder & Investor</div>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
<!--   <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li> -->
  
  <li class='icon'>
    <a href="https://github.com/sotoseattle/">
      <img src="/images/logos/github_icon.png" width="36" height="27">
      </img>
    </a>
  </li>
  <li class='icon'>
    <a href="https://www.linkedin.com/in/sotoseattle/">
      <img src="/images/logos/linkedin-256.png"  width="27" height="27">
      </img>
    </a>
  </li>
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:sotoseattle.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
<!--   <li><a href="projects/">Projects</a></li> -->
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <!-- <li><a href="/images/Javier_Soto_resume.pdf">Resume</a></li> -->
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/11/03/Genetic-BN/">Genetic Bayesian Network (I)</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-11-03T08:01:00-08:00" pubdate data-updated="true">Nov 3<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>[UPDATE] I have updated a posteriori the code to include the vectorized version of Factor manipulations, which is incredibly faster and will be explained in a later post.</p>

<p>As a first exercise I am going to create the typical genetic Bayesian network. Given a family tree, for each member of the family we are going to have two nodes, one for the person’s genotype, and another for her phenotype. The template would be:</p>

<p><img class="center" src="/images/nov13/template.png" width="500" title="Template for Genetic Bayesian Network" /></p>

<h2 id="phenotype-factor">phenotype Factor</h2>
<p>The Phenotype of a person will depend on her Genotype, so there is a single link between both nodes. The factor that describes this relationship (probability of trait present given the genotype) will be a function that computes the probability of each possible assignment. </p>

<p>The phenotype can be either present (val 0) or not (val 1) with a cardinality of 2.</p>

<p>In the simplest case the genotype has 2 alleles and each one can be dominant (A) or recessive (a). The presence of the dominant allele (A) determines the presence of the trait. </p>

<p>This means a total of 3 possible allele combinations: AA, Aa==aA, aa. For example, given a genotype x_3, the conditional probabilities of phenotype x_1 showing up are:</p>

<table class="widetable">
  <thead>
    <tr>
      <th style="text-align: left"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: left"> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">p(x_1 | x_3)</td>
      <td style="text-align: right">AA</td>
      <td style="text-align: right">Aa</td>
      <td style="text-align: right">aa</td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left">present</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">0</td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left">absent</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
      <td style="text-align: left"> </td>
    </tr>
  </tbody>
</table>

<p><br />
In a fast and dirty way the above becomes:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Factor for phenotype given genotype in Mendellian manner</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">geno</span>  <span class="o">=</span> <span class="n">Rvar</span><span class="o">.</span><span class="n">Rvar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span class="line"><span class="n">pheno</span> <span class="o">=</span> <span class="n">Rvar</span><span class="o">.</span><span class="n">Rvar</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">Factor_phenotype_given_genotype_Mendelian</span><span class="p">(</span><span class="n">isDominant</span><span class="p">,</span> <span class="n">genoVar</span><span class="p">,</span> <span class="n">phenoVar</span><span class="p">):</span>
</span><span class="line">    <span class="n">varis</span> <span class="o">=</span> <span class="p">[</span><span class="n">phenoVar</span><span class="p">,</span> <span class="n">genoVar</span><span class="p">]</span> <span class="c"># written like in cond prob order</span>
</span><span class="line">    <span class="k">if</span> <span class="n">isDominant</span><span class="p">:</span>
</span><span class="line">        <span class="n">valus</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
</span><span class="line">    <span class="k">else</span><span class="p">:</span>
</span><span class="line">        <span class="n">valus</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
</span><span class="line">    <span class="n">f</span> <span class="o">=</span> <span class="n">Factor</span><span class="o">.</span><span class="n">Factor</span><span class="p">(</span><span class="n">varis</span><span class="p">)</span>
</span><span class="line">    <span class="n">f</span><span class="o">.</span><span class="n">fill_values</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valus</span><span class="p">))</span>
</span><span class="line">    <span class="k">return</span> <span class="n">f</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Generalizing the previous case we can determine probabilities for the presence of the trait. For this we supply an alphaList that tells us the probability of presenting the trait if certain genotype is present. For example, continuing the previous example, and alphaList of [0.8, 0.6, 0.1] that correlates with genotypes [AA, Aa, aa], means that if the AA is present, the probability of having the trait is 80%.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Factor for phenotype given genotype and probabilities</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">Factor_phenotype_given_genotype_Not_Mendelian</span><span class="p">(</span><span class="n">alphaList</span><span class="p">,</span> <span class="n">genoVar</span><span class="p">,</span> <span class="n">phenoVar</span><span class="p">):</span>
</span><span class="line">    <span class="n">ff</span> <span class="o">=</span> <span class="n">Factor</span><span class="o">.</span><span class="n">Factor</span><span class="p">([</span><span class="n">phenoVar</span><span class="p">,</span> <span class="n">genoVar</span><span class="p">])</span> <span class="c"># written like in cond prob order</span>
</span><span class="line">    <span class="n">order</span><span class="p">,</span> <span class="n">dic</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">idx2ass</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
</span><span class="line">    <span class="n">arr</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span class="line">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alphaList</span><span class="p">)):</span>
</span><span class="line">        <span class="n">v</span> <span class="o">=</span> <span class="n">alphaList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class="line">        <span class="n">k</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">index</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>  <span class="c"># trait present</span>
</span><span class="line">        <span class="n">arr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</span><span class="line">        <span class="n">arr</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="n">v</span>    <span class="c"># trait absent</span>
</span><span class="line">    <span class="n">ff</span><span class="o">.</span><span class="n">fill_values</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">ff</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="genotype-factor-without-inheritance">genotype Factor without inheritance</h2>

<p>The simplest Factor for genotype is the one that does not depend on inheritance and instead depends solely on the frequency of the alleles showing up in the general population. </p>

<p>We consider these probabilities to be independent. As a result, the probability of a genotype is the product of the frequencies of its constituent alleles.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Factor Genotype given Alleles frequency (in general population)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">genes2Alleles</span><span class="p">(</span><span class="n">numAlleles</span><span class="p">):</span>
</span><span class="line">    <span class="n">sol</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numAlleles</span><span class="p">):</span>
</span><span class="line">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">numAlleles</span><span class="p">):</span>
</span><span class="line">            <span class="n">sol</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">count</span>
</span><span class="line">            <span class="n">count</span> <span class="o">+=</span><span class="mi">1</span>
</span><span class="line">    <span class="k">return</span> <span class="n">sol</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">Factor_genotype_given_allele_freqs</span><span class="p">(</span><span class="n">alleleFreqs</span><span class="p">,</span> <span class="n">genoVar</span><span class="p">):</span>
</span><span class="line">    <span class="n">ff</span> <span class="o">=</span> <span class="n">Factor</span><span class="o">.</span><span class="n">Factor</span><span class="p">([</span><span class="n">genoVar</span><span class="p">])</span>
</span><span class="line">
</span><span class="line">    <span class="n">numAlleles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alleleFreqs</span><span class="p">)</span>
</span><span class="line">    <span class="n">numGenotypes</span> <span class="o">=</span> <span class="n">genoVar</span><span class="o">.</span><span class="n">totCard</span><span class="p">()</span>
</span><span class="line">    <span class="n">chocho</span> <span class="o">=</span> <span class="n">genes2Alleles</span><span class="p">(</span><span class="n">numAlleles</span><span class="p">)</span>
</span><span class="line">    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numAlleles</span><span class="p">):</span>
</span><span class="line">        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numAlleles</span><span class="p">):</span>
</span><span class="line">            <span class="n">key</span> <span class="o">=</span> <span class="n">chocho</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)))]</span>
</span><span class="line">            <span class="n">ff</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alleleFreqs</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">*</span><span class="n">alleleFreqs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
</span><span class="line">    <span class="k">return</span> <span class="n">ff</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="genotype-factor-without-inheritance-1">genotype Factor without inheritance</h2>

<p>Finally, the probabilities of having a certain genotype based on the genotypes of the parents:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Factor Genotype given Parents Genotypes</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">numGenos</span><span class="p">(</span><span class="n">numAlleles</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="n">numAlleles</span><span class="o">*</span><span class="p">(</span><span class="n">numAlleles</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">Factor_genotype_given_parents_genes</span><span class="p">(</span><span class="n">numAlleles</span><span class="p">,</span> <span class="n">genKid</span><span class="p">,</span> <span class="n">genDad</span><span class="p">,</span> <span class="n">genMom</span><span class="p">):</span>
</span><span class="line">    <span class="n">ff</span> <span class="o">=</span> <span class="n">Factor</span><span class="o">.</span><span class="n">Factor</span><span class="p">([</span><span class="n">genKid</span><span class="p">,</span> <span class="n">genDad</span><span class="p">,</span> <span class="n">genMom</span><span class="p">])</span>
</span><span class="line">    <span class="n">order</span><span class="p">,</span> <span class="n">dic</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">idx2ass</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
</span><span class="line">    <span class="n">chocho</span> <span class="o">=</span> <span class="n">genes2Alleles</span><span class="p">(</span><span class="n">numAlleles</span><span class="p">)</span>
</span><span class="line">    <span class="n">kid</span> <span class="o">=</span> <span class="n">chocho</span>
</span><span class="line">    <span class="n">dad</span> <span class="o">=</span> <span class="n">chocho</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span class="line">    <span class="n">mom</span> <span class="o">=</span> <span class="n">chocho</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span class="line">    <span class="n">arr</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span class="line">    <span class="k">for</span> <span class="n">dad_gen</span> <span class="ow">in</span> <span class="n">dad</span><span class="p">:</span>
</span><span class="line">        <span class="k">for</span> <span class="n">mom_gen</span> <span class="ow">in</span> <span class="n">mom</span><span class="p">:</span>
</span><span class="line">            <span class="k">for</span> <span class="n">kid_gen</span> <span class="ow">in</span> <span class="n">kid</span><span class="p">:</span>
</span><span class="line">                <span class="n">hits</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span class="line">                <span class="k">for</span> <span class="n">chuchu</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">dad_gen</span><span class="p">,</span> <span class="n">mom_gen</span><span class="p">):</span>
</span><span class="line">                    <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">chuchu</span><span class="p">)</span><span class="o">==</span><span class="nb">list</span><span class="p">(</span><span class="n">kid_gen</span><span class="p">):</span>
</span><span class="line">                        <span class="n">hits</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="line">                <span class="n">hits</span> <span class="o">=</span> <span class="n">hits</span><span class="o">/</span><span class="mf">4.</span>
</span><span class="line">                <span class="n">arr</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">index</span><span class="p">((</span><span class="n">kid</span><span class="p">[</span><span class="n">kid_gen</span><span class="p">],</span> <span class="n">dad</span><span class="p">[</span><span class="n">dad_gen</span><span class="p">],</span> <span class="n">mom</span><span class="p">[</span><span class="n">mom_gen</span><span class="p">]))]</span> <span class="o">=</span> <span class="n">hits</span>
</span><span class="line">    <span class="n">ff</span><span class="o">.</span><span class="n">fill_values</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">ff</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="building-the-genetic-network">building the genetic network</h2>

<p>Self explanatory. For a given family tree we create the variables and factors associated to each person/node.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>putting it all together</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">geneticNetwork</span><span class="p">(</span><span class="n">pedigree</span><span class="p">,</span> <span class="n">alleleFreqs</span><span class="p">,</span> <span class="n">alphaList</span><span class="p">):</span>
</span><span class="line">    <span class="n">PHENOTYPE_CARD</span> <span class="o">=</span> <span class="mi">2</span> <span class="c"># present or absent</span>
</span><span class="line">    <span class="n">numAlleles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alleleFreqs</span><span class="p">)</span>
</span><span class="line">    <span class="n">numG</span> <span class="o">=</span> <span class="n">numGenos</span><span class="p">(</span><span class="n">numAlleles</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="n">varList</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">
</span><span class="line">    <span class="c"># first we create all variables</span>
</span><span class="line">    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pedigree</span><span class="p">:</span>
</span><span class="line">        <span class="n">varList</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">        <span class="n">varList</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;var_geno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Rvar</span><span class="o">.</span><span class="n">Rvar</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">numG</span><span class="p">)</span>
</span><span class="line">        <span class="n">count</span> <span class="o">+=</span><span class="mi">1</span>
</span><span class="line">        <span class="n">varList</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;var_pheno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Rvar</span><span class="o">.</span><span class="n">Rvar</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">PHENOTYPE_CARD</span><span class="p">)</span>
</span><span class="line">        <span class="n">count</span> <span class="o">+=</span><span class="mi">1</span>
</span><span class="line">
</span><span class="line">    <span class="c"># and now the factors</span>
</span><span class="line">    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pedigree</span><span class="p">:</span>
</span><span class="line">        <span class="n">kid_gn</span> <span class="o">=</span> <span class="n">varList</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;var_geno&#39;</span><span class="p">]</span>
</span><span class="line">        <span class="n">kid_ph</span> <span class="o">=</span> <span class="n">varList</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;var_pheno&#39;</span><span class="p">]</span>
</span><span class="line">
</span><span class="line">        <span class="n">dad_gn</span><span class="p">,</span> <span class="n">mom_gn</span> <span class="o">=</span> <span class="n">pedigree</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span class="line">        <span class="k">if</span> <span class="n">dad_gn</span> <span class="ow">and</span> <span class="n">mom_gn</span><span class="p">:</span>
</span><span class="line">            <span class="n">dad_gn</span> <span class="o">=</span> <span class="n">varList</span><span class="p">[</span><span class="n">dad_gn</span><span class="p">][</span><span class="s">&#39;var_geno&#39;</span><span class="p">]</span>
</span><span class="line">            <span class="n">mom_gn</span> <span class="o">=</span> <span class="n">varList</span><span class="p">[</span><span class="n">mom_gn</span><span class="p">][</span><span class="s">&#39;var_geno&#39;</span><span class="p">]</span>
</span><span class="line">            <span class="n">ff</span> <span class="o">=</span> <span class="n">Factor_genotype_given_parents_genes</span><span class="p">(</span><span class="n">numAlleles</span><span class="p">,</span> <span class="n">kid_gn</span><span class="p">,</span> <span class="n">dad_gn</span><span class="p">,</span> <span class="n">mom_gn</span><span class="p">)</span>
</span><span class="line">        <span class="k">else</span><span class="p">:</span>
</span><span class="line">            <span class="n">ff</span> <span class="o">=</span> <span class="n">Factor_genotype_given_allele_freqs</span><span class="p">(</span><span class="n">alleleFreqs</span><span class="p">,</span> <span class="n">kid_gn</span><span class="p">)</span>
</span><span class="line">        <span class="n">varList</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;factor_geno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff</span>
</span><span class="line">        <span class="n">varList</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;factor_pheno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Factor_phenotype_given_genotype_Not_Mendelian</span><span class="p">(</span><span class="n">alphaList</span><span class="p">,</span> <span class="n">kid_gn</span><span class="p">,</span> <span class="n">kid_ph</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">return</span> <span class="n">varList</span>
</span><span class="line">
</span><span class="line"><span class="c"># this is fugly</span>
</span><span class="line"><span class="k">def</span> <span class="nf">modify_Factor_by_evidence</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">ass</span><span class="p">):</span>
</span><span class="line">    <span class="n">factor</span> <span class="o">=</span> <span class="n">GN</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;factor_&#39;</span><span class="o">+</span><span class="n">node</span><span class="p">]</span>
</span><span class="line">    <span class="n">randvar</span> <span class="o">=</span> <span class="n">GN</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;var_&#39;</span><span class="o">+</span><span class="n">node</span><span class="p">]</span>
</span><span class="line">    <span class="n">GN</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;factor_&#39;</span><span class="o">+</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">FactorOperations</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="p">{</span><span class="n">randvar</span><span class="p">:</span><span class="n">ass</span><span class="p">})</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">build_joint_cpd</span><span class="p">():</span>
</span><span class="line">    <span class="n">a</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class="line">    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">GN</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span class="line">        <span class="n">b</span> <span class="o">=</span> <span class="n">FactorOperations</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">GN</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;factor_geno&#39;</span><span class="p">],</span> <span class="n">GN</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;factor_pheno&#39;</span><span class="p">])</span>
</span><span class="line">        <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
</span><span class="line">            <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
</span><span class="line">        <span class="k">else</span><span class="p">:</span>
</span><span class="line">            <span class="n">a</span> <span class="o">=</span> <span class="n">FactorOperations</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">a</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/11/02/PGN/">Probabilistic Graphical Networks</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-11-02T08:01:00-07:00" pubdate data-updated="true">Nov 2<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The next few days I’ll be going over the Probabilistic Graphical Networks course I did in Coursera. I am not going to go to heavy on theory because it way too much material for this blog. I’ll focus on the exercises, which I’ll try to implement in Python</p>

<p>As an intro, here is my initial stab for manipulating Factors, the building block of PGNs. Consider that there are way to many loops and I need to find ways to vectorize the most frequent operations or this code will never be practical. This needs heavy refactoring.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Factors and Random Variables</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
<span class="line-number">96</span>
<span class="line-number">97</span>
<span class="line-number">98</span>
<span class="line-number">99</span>
<span class="line-number">100</span>
<span class="line-number">101</span>
<span class="line-number">102</span>
<span class="line-number">103</span>
<span class="line-number">104</span>
<span class="line-number">105</span>
<span class="line-number">106</span>
<span class="line-number">107</span>
<span class="line-number">108</span>
<span class="line-number">109</span>
<span class="line-number">110</span>
<span class="line-number">111</span>
<span class="line-number">112</span>
<span class="line-number">113</span>
<span class="line-number">114</span>
<span class="line-number">115</span>
<span class="line-number">116</span>
<span class="line-number">117</span>
<span class="line-number">118</span>
<span class="line-number">119</span>
<span class="line-number">120</span>
<span class="line-number">121</span>
<span class="line-number">122</span>
<span class="line-number">123</span>
<span class="line-number">124</span>
<span class="line-number">125</span>
<span class="line-number">126</span>
<span class="line-number">127</span>
<span class="line-number">128</span>
<span class="line-number">129</span>
<span class="line-number">130</span>
<span class="line-number">131</span>
<span class="line-number">132</span>
<span class="line-number">133</span>
<span class="line-number">134</span>
<span class="line-number">135</span>
<span class="line-number">136</span>
<span class="line-number">137</span>
<span class="line-number">138</span>
<span class="line-number">139</span>
<span class="line-number">140</span>
<span class="line-number">141</span>
<span class="line-number">142</span>
<span class="line-number">143</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">Rvar</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">copy</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Factor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;Factor : CPD Conditional Probability (discrete) Distribution</span>
</span><span class="line"><span class="sd">      var    Vector of variables in the factor, e.g. [1 2 3] =&gt; X1, X2, X3</span>
</span><span class="line"><span class="sd">      card   Vector of cardinalities of var, e.g. [2 2 2] =&gt; all binomials</span>
</span><span class="line"><span class="sd">      val    Value table with the conditional probabilities</span>
</span><span class="line"><span class="sd">      size   Length of val array = prod(card)&quot;&quot;&quot;</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">],</span> <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">variables</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">cards</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">totCard</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">]</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span>
</span><span class="line">        <span class="k">elif</span> <span class="n">values</span> <span class="o">!=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]:</span>
</span><span class="line">            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Mismatch of values size&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">multiply_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fB</span><span class="p">):</span>
</span><span class="line">        <span class="n">fC</span> <span class="o">=</span> <span class="n">Factor</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">fB</span><span class="o">.</span><span class="n">variables</span><span class="p">))))</span>
</span><span class="line">        <span class="n">mapA</span> <span class="o">=</span> <span class="p">[</span><span class="n">fC</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">]</span>
</span><span class="line">        <span class="n">mapB</span> <span class="o">=</span> <span class="p">[</span><span class="n">fC</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">fB</span><span class="o">.</span><span class="n">variables</span><span class="p">]</span>
</span><span class="line">        <span class="n">assignmentsC</span> <span class="o">=</span> <span class="n">fC</span><span class="o">.</span><span class="n">idx2ass</span><span class="p">([])</span>
</span><span class="line">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">assC</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assignmentsC</span><span class="p">):</span>
</span><span class="line">            <span class="n">assA</span> <span class="o">=</span> <span class="p">[</span><span class="n">assC</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">mapA</span><span class="p">]</span>
</span><span class="line">            <span class="n">assB</span> <span class="o">=</span> <span class="p">[</span><span class="n">assC</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">mapB</span><span class="p">]</span>
</span><span class="line">            <span class="n">fC</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ass2idx</span><span class="p">(</span><span class="n">assA</span><span class="p">)]</span><span class="o">*</span><span class="n">fB</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">fB</span><span class="o">.</span><span class="n">ass2idx</span><span class="p">(</span><span class="n">assB</span><span class="p">)]</span>
</span><span class="line">        <span class="k">return</span> <span class="n">fC</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">marginalize_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vs</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="n">vs</span><span class="o">==</span><span class="p">[]:</span>
</span><span class="line">            <span class="k">return</span> <span class="bp">self</span>
</span><span class="line">        <span class="n">cvs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">vs</span><span class="p">))</span>
</span><span class="line">        <span class="k">if</span> <span class="n">cvs</span><span class="o">==</span><span class="p">[]:</span>
</span><span class="line">            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Error: Resultant factor has empty scope&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="n">fC</span> <span class="o">=</span> <span class="n">Factor</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">cvs</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">        <span class="n">assignmentsC</span> <span class="o">=</span> <span class="n">fC</span><span class="o">.</span><span class="n">idx2ass</span><span class="p">([])</span>
</span><span class="line">        <span class="n">mapC</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fC</span><span class="o">.</span><span class="n">variables</span><span class="p">]</span>
</span><span class="line">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">old_ass</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx2ass</span><span class="p">([])):</span>
</span><span class="line">            <span class="n">assC</span> <span class="o">=</span> <span class="p">[</span><span class="n">old_ass</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">mapC</span><span class="p">]</span>
</span><span class="line">            <span class="n">fC</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">fC</span><span class="o">.</span><span class="n">ass2idx</span><span class="p">(</span><span class="n">assC</span><span class="p">)]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class="line">        <span class="n">z</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fC</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span class="line">        <span class="n">fC</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">/</span><span class="n">z</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">fC</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
</span><span class="line">        <span class="k">return</span> <span class="n">fC</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">conditioned_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evidence</span><span class="p">):</span>
</span><span class="line">        <span class="n">condVars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">evidence</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</span><span class="line">        <span class="k">if</span> <span class="n">condVars</span><span class="o">==</span><span class="p">[]:</span>
</span><span class="line">            <span class="k">return</span> <span class="bp">self</span>
</span><span class="line">        <span class="n">fC</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="n">idx</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
</span><span class="line">            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">evidence</span><span class="p">:</span>
</span><span class="line">                <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evidence</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
</span><span class="line">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ass</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx2ass</span><span class="p">([])):</span>
</span><span class="line">            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ass</span><span class="p">):</span>
</span><span class="line">                <span class="k">if</span> <span class="n">j</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
</span><span class="line">                    <span class="n">fC</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span class="line">        <span class="k">return</span> <span class="n">fC</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">ass2idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ass</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="n">ass</span><span class="o">.</span><span class="n">__class__</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
</span><span class="line">            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;assignment is not a list&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="n">suma</span><span class="p">,</span> <span class="n">prod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
</span><span class="line">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span class="line">            <span class="n">prod</span> <span class="o">*=</span> <span class="n">e</span>
</span><span class="line">            <span class="n">evidence</span> <span class="o">=</span> <span class="n">ass</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class="line">            <span class="k">if</span> <span class="n">evidence</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span class="line">                <span class="k">raise</span> <span class="s">&quot;assignment not valid&quot;</span>
</span><span class="line">            <span class="n">suma</span> <span class="o">+=</span> <span class="n">prod</span><span class="o">*</span><span class="p">(</span><span class="n">evidence</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">suma</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">idx2ass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indicesArray</span><span class="p">):</span>
</span><span class="line">        <span class="n">limit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="n">indicesArray</span><span class="o">.</span><span class="n">__class__</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
</span><span class="line">            <span class="k">raise</span> <span class="s">&quot;assignment is not an array of indices&quot;</span>
</span><span class="line">        <span class="k">elif</span> <span class="n">indicesArray</span> <span class="o">==</span> <span class="p">[]:</span>
</span><span class="line">            <span class="n">indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">limit</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">        <span class="k">else</span><span class="p">:</span>
</span><span class="line">            <span class="n">indices</span> <span class="o">=</span> <span class="n">indicesArray</span>
</span><span class="line">
</span><span class="line">        <span class="n">t</span><span class="p">,</span> <span class="n">sol</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span class="line">        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
</span><span class="line">            <span class="k">if</span> <span class="n">e</span><span class="o">&gt;</span><span class="n">limit</span><span class="p">:</span>
</span><span class="line">                <span class="k">raise</span> <span class="s">&quot;index beyond scope of factor values&quot;</span>
</span><span class="line">            <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">e</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">))</span>
</span><span class="line">        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
</span><span class="line">            <span class="n">prod</span><span class="p">,</span> <span class="n">ass</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[]</span>
</span><span class="line">            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span class="line">                <span class="n">prod</span> <span class="o">*=</span> <span class="n">e</span>
</span><span class="line">                <span class="n">ass</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">prod</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span class="line">            <span class="n">sol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ass</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">sol</span>
</span><span class="line">
</span><span class="line">    <span class="nd">@classmethod</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">joint</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">factorList</span><span class="p">):</span>
</span><span class="line">        <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factorList</span><span class="p">]</span>
</span><span class="line">        <span class="n">allVars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
</span><span class="line">        <span class="n">fC</span> <span class="o">=</span> <span class="n">Factor</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">allVars</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">        <span class="n">maps</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factorList</span><span class="p">:</span>
</span><span class="line">            <span class="n">maps</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fC</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">])</span>
</span><span class="line">
</span><span class="line">        <span class="n">assignmentsC</span> <span class="o">=</span> <span class="n">fC</span><span class="o">.</span><span class="n">idx2ass</span><span class="p">([])</span>
</span><span class="line">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">assC</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assignmentsC</span><span class="p">):</span>
</span><span class="line">            <span class="n">prod</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class="line">            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">factorList</span><span class="p">):</span>
</span><span class="line">                <span class="n">ass</span> <span class="o">=</span> <span class="p">[</span><span class="n">assC</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">maps</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
</span><span class="line">                <span class="n">prod</span> <span class="o">*=</span> <span class="n">f</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">ass2idx</span><span class="p">(</span><span class="n">ass</span><span class="p">)]</span>
</span><span class="line">            <span class="n">fC</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">prod</span>
</span><span class="line">        <span class="k">return</span> <span class="n">fC</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Rvar</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">variable</span>
</span><span class="line">        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
</span><span class="line">          <span class="bp">self</span><span class="o">.</span><span class="n">cd</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">card</span><span class="p">)</span>
</span><span class="line">        <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
</span><span class="line">          <span class="bp">self</span><span class="o">.</span><span class="n">cd</span> <span class="o">=</span> <span class="n">card</span>
</span><span class="line">        <span class="k">else</span><span class="p">:</span>
</span><span class="line">          <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;wrong cardinality&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">totCard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span>
</span><span class="line">
</span><span class="line">    <span class="n">__str__</span> <span class="o">=</span> <span class="n">__repr__</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/10/28/Data-Science-London/">Data Science London</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-10-28T21:02:00-07:00" pubdate data-updated="true">Oct 28<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a post about my third tutorial competition, Data Science London.</p>

<p>The training data consists of 1,000 records with 40 features. We need to classify each record as 1 or 0. The test set consists of 9,000 additional records.</p>

<p>After playing a bit with the training set one realizes that there is a ton of noise in the data, and that we need to carefully distill the features to get something of value. Furthermore, the noisy data is supported by the fact that the features were created artificially for the purpose of this tutorial competition.</p>

<h2 id="feature-selection">feature selection</h2>

<p>To start cleaning up the data a first approach is to see which features give the most predictive power. To do this I use an SVM with Gaussian kernel. Then I find the feature that gives the most predictive power. Then I repeat the process finding the feature that added to the previously selected achieves the highest accuracy. </p>

<p>Another way is to use the ExtraTreesClassifier from the scikit package which results in the following chart of the importance of features (<a href="http://scikit-learn.org/stable/auto_examples/ensemble/plot_forest_importances.html#example-ensemble-plot-forest-importances-py">link</a>):</p>

<p><img class="center" src="/images/kaggle_scilondon/features_power_svm.png" width="600" /></p>

<table class="widetable">
  <thead>
    <tr>
      <th style="text-align: left"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
      <th style="text-align: right"> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">SVM</td>
      <td style="text-align: right">14</td>
      <td style="text-align: right">12</td>
      <td style="text-align: right">29</td>
      <td style="text-align: right">6</td>
      <td style="text-align: right">36</td>
      <td style="text-align: right">39</td>
      <td style="text-align: right">7</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">28</td>
      <td style="text-align: right">19</td>
      <td style="text-align: right">22</td>
      <td style="text-align: right">18</td>
      <td style="text-align: right">38</td>
      <td style="text-align: right">3</td>
      <td style="text-align: right">32</td>
      <td style="text-align: right">34</td>
      <td style="text-align: right">13</td>
    </tr>
    <tr>
      <td style="text-align: left">TreesClassif</td>
      <td style="text-align: right">14</td>
      <td style="text-align: right">12</td>
      <td style="text-align: right">6</td>
      <td style="text-align: right">39</td>
      <td style="text-align: right">36</td>
      <td style="text-align: right">18</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">32</td>
      <td style="text-align: right">38</td>
      <td style="text-align: right">29</td>
      <td style="text-align: right">28</td>
      <td style="text-align: right">23</td>
      <td style="text-align: right">22</td>
      <td style="text-align: right">34</td>
      <td style="text-align: right">7</td>
      <td style="text-align: right">9</td>
      <td style="text-align: right">10</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<p>Only using the feature number 14 we already guess right more than 2/3 of the times. As we add features we increase the accuracy until it stabilizes somewhere between the first 10 and 22 features. Then, the added noise starts to degrade the model and lose predictive power. Optimizing hyper-parameters for the first 18 features we achieve 93.6% on cross validation and 91.84% on the 9,000 samples test set.</p>

<p>ALTERNATIVE WAYS TO CHOOSE FEATURES FROM SCIKIT</p>

<h2 id="dimensionality-reduction">dimensionality reduction</h2>

<p>Even after choosing the set of features we still have way too much noise in the data. One way to ‘clean it up’ is through dimensionality reduction. This has a good and a bad aspect. On one hand, it is a dangerous practice since what we do is project into a lower dimension space all the features and in the process we loose data, maybe valuable. On the other hand, it allows us to apply ‘whitening’, removing data points that are close by and highly correlated.</p>

<p>In this case it pays to apply PCA because I rather start with less valuable data but more salient, than more noisy and diffuse information. Here are two images with accuracy on the first 100 records of training an SVM on the subsequent 900 for different sets of features and dimensions. The left one comes from the main features derived from the tree classifier, the right most from the cycling svm:</p>

<p><img class="left" src="/images/kaggle_scilondon/feat_dim_trees.png" width="420" title="Features from trees" /></p>

<p><img class="right" src="/images/kaggle_scilondon/feat_dim_svm.png" width="420" title="Features from SVM" /></p>

<p><br /></p>

<p>My SVM set achieves a maximum accuracy of 97% for the first 14 features reduced to 12 dimensions. The forest one achieves a top 96% for a wider set of combinations (&gt; 12 features and 12-13 dimensions).</p>

<p>As an aside, I tried all kinds of different approaches available in the scikit package for dim reduction, except for the ‘kernel pca’ that took too long. The best result was achieved with Random PCA on my reduced set of 14 features and reduced to 12 dimensions. These 12 dimensions explain something like half of the variance when considering the whole feature set, and around 90% of the variance in the reduced feature set.</p>

<p><img class="center" src="/images/kaggle_scilondon/explained_var.png" width="500" title="Variance explained from dimensions" /></p>

<p>One final note. It is easy to code the PCA algorithm. Nevertheless I used the SciKit tool because it includes the Random PCA and whitening (which still escapes me). Here is the code for bare-bones PCA:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>barebones PCA</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">pca</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span class="line">	<span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
</span><span class="line">	<span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span class="line">	<span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span class="line">	<span class="n">Sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span class="line">	<span class="k">print</span> <span class="s">&#39;Sigma shape should be nxn:&#39;</span><span class="p">,</span> <span class="n">Sigma</span><span class="o">.</span><span class="n">shape</span>
</span><span class="line">	<span class="k">print</span> <span class="s">&#39;U will be m x &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Sigma</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span class="line">	<span class="n">U</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">Sigma</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class="line">	<span class="k">return</span> <span class="p">[</span><span class="n">U</span><span class="p">,</span> <span class="n">S</span><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">shrink</span><span class="p">(</span><span class="n">example_norm</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">):</span>
</span><span class="line">	<span class="n">Ureduce</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">dimensions</span><span class="p">]</span>
</span><span class="line">	<span class="n">Z</span> <span class="o">=</span> <span class="n">example_norm</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ureduce</span><span class="p">)</span>
</span><span class="line">	<span class="k">return</span> <span class="n">Z</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">inflate</span><span class="p">(</span><span class="n">shrunk_data</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">):</span>
</span><span class="line">	<span class="n">Ureduce</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">dimensions</span><span class="p">]</span>
</span><span class="line">	<span class="n">X_rec</span> <span class="o">=</span> <span class="n">shrunk_data</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ureduce</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span class="line">	<span class="k">return</span> <span class="n">X_rec</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="engorging-the-training-by-guessing">engorging the training by guessing</h2>

<p>We have an inherent asymmetry: 1000 training records and 9000 for testing. If we could pass records from the testing to the training set we could boost the model’s power. The problem is that we don’t have the labels of the testing set records. But they are so many that we could run our model on the testing set and believe that the few predictions made with very high probability are so certain as to take them as ‘real’. </p>

<p>In an initial pass of the SVM over the testing set we select the predicted records with probability higher than 99% and add them to our training set. We measure the accuracy on a separated cross validation set and store the result. We repeat the process over and over and only stop when the accuracy on the CV set goes down. We end up with around 8,508 records, 2,316 support vectors, and an accuracy of around 97% on cross validation.</p>

<p>The intuition behind the idea is that although we don’t gain anything from certain added records (because we were already pretty sure where they fell), the addition to the training set will allow other less apparent features and subtleties gain contrast and predictive power.</p>

<p>At the end of this process we have a huge, if slightly screwed up training set that gives us the following accuracies against our cross validation set:</p>

<table class="widetable">
  <thead>
    <tr>
      <th style="text-align: left"> </th>
      <th style="text-align: center">precision</th>
      <th style="text-align: center">recall</th>
      <th style="text-align: center">f1-score</th>
      <th style="text-align: right">support</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">label 0</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: right">149</td>
    </tr>
    <tr>
      <td style="text-align: left">label 1</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: right">151</td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">avg / total</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: right">300</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<h2 id="experiment-with-nn">experiment with NN</h2>

<p>As an experiment, we train a neural network with quite an excess of nodes [input: 18, hidden_1: 36, hidden_2: 36, output: 2] on the engorged training set. Then for each prediction made by SVM and NN, in case the models disagree, whoever assigns the highest probability to his choice decides.</p>

<p>Run on the CV set we got the same result:</p>

<table class="widetable">
  <thead>
    <tr>
      <th style="text-align: left"> </th>
      <th style="text-align: center">precision</th>
      <th style="text-align: center">recall</th>
      <th style="text-align: center">f1-score</th>
      <th style="text-align: right">support</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">label 0</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: right">149</td>
    </tr>
    <tr>
      <td style="text-align: left">label 1</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: right">151</td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td style="text-align: left">avg / total</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: center">0.97</td>
      <td style="text-align: right">300</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<p>Both models differed on just 10 samples (3%) and in 5 cases the NN decided. The NN didn’t do better than the SVM, it just had a different opinion on some borderline cases.</p>

<h2 id="final-submission">final submission</h2>

<p>I have rerun my algorithm multiple times trying to find the best initial feature set and best randomized path that engorges the data. My last few consistent scores were between 95.45 and 95.827.</p>

<p>My final submissions came down to: </p>

<ul>
  <li>a newly distilled feature set of 20 features, </li>
  <li>tweaked hyper-parameters,</li>
  <li>the patience to run the engorgement algorithm until I got 97.66% on CV</li>
  <li>8,808 training records guessed with p&gt;0.99 and 2,635 support vectors</li>
  <li>and using the mix model</li>
</ul>

<p>which achieves a 95.566% (a tad better than the SVM alone). </p>

<p>Two days back, out of chance with the same mix strategy on a randomly optimized set I got my best (though I suspect overfit) result:</p>

<blockquote><p>Kaggle&#8217;s position 9 with 95.827% accuracy.</p></blockquote>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/19/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/17/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/03/11/Hunting-Tips/">Hunting Tips</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/12/Promises/">Founder Forecasts: a double-edged sword</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/18/Unicorns/">Gazelles and Unicorns</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/18/Founders/">Psyc Founders Out</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/05/ruby-continuations/">Ruby Continuations</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 -  Javier Soto <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> + <a href="https://github.com/ioveracker/mnml">mnml</a>.
	  
  </span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sotoseattle';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>
